{% extends 'base.html' %}

{% block title %}Manage Marks - Student Performance System{% endblock %}

{% block content %}
<div style="background-color: var(--primary-bg); min-height: calc(100vh - 70px); padding: 2rem 0;">
    <div class="container-xxl">
        <!-- Page Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h2 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.5rem;">Manage Student Marks</h2>
                <p style="color: var(--text-secondary); margin-bottom: 0;">Add and manage student marks and attendance</p>
            </div>
            <button class="btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addMarksModal">
                ➕ Add Marks
            </button>
        </div>

        <!-- Filters -->
        <div class="card-custom" style="margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <label class="form-label-custom">Filter by Student</label>
                    <select class="form-control-custom w-100" id="studentFilter" onchange="loadMarks()">
                        <option value="">All Students</option>
                    </select>
                </div>
                <div>
                    <label class="form-label-custom">Filter by Subject</label>
                    <select class="form-control-custom w-100" id="subjectFilter" onchange="loadMarks()">
                        <option value="">All Subjects</option>
                    </select>
                </div>
                <div>
                    <label class="form-label-custom">Search</label>
                    <input type="text" class="form-control-custom w-100" id="searchInput" placeholder="Search marks..." onkeyup="loadMarks()">
                </div>
            </div>
        </div>

        <!-- Marks Table -->
        <div class="card-custom">
            <div id="marksContainer">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <h3>No marks available</h3>
                    <p>Add marks to begin tracking student performance</p>
                </div>
            </div>

            <table class="table-custom" style="display: none; width: 100%;" id="marksTable">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Roll No</th>
                        <th>Subject</th>
                        <th>Marks</th>
                        <th>Attendance %</th>
                        <th>Grade</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marksTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Marks Modal -->
<div class="modal fade" id="addMarksModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--secondary-bg); border: 1px solid var(--border-color);">
            <div class="modal-header" style="background-color: var(--tertiary-bg); border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" style="color: var(--text-primary);">Add Student Marks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <form id="addMarksForm">
                    <div class="mb-3">
                        <label class="form-label-custom">Student</label>
                        <select class="form-control-custom w-100" id="studentSelect" required>
                            <option value="">Select Student</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-custom">Subject</label>
                        <select class="form-control-custom w-100" id="subjectSelect" required>
                            <option value="">Select Subject</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-custom">Marks Obtained (0-100)</label>
                        <input type="number" class="form-control-custom w-100" id="marksInput" min="0" max="100" placeholder="Enter marks" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-custom">Attendance Percentage (0-100)</label>
                        <input type="number" class="form-control-custom w-100" id="attendanceInput" min="0" max="100" placeholder="Enter attendance %" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem;">
                <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-primary-custom" onclick="addMarks()">Save Marks</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Marks Modal -->
<div class="modal fade" id="editMarksModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--secondary-bg); border: 1px solid var(--border-color);">
            <div class="modal-header" style="background-color: var(--tertiary-bg); border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" style="color: var(--text-primary);">Edit Student Marks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <form id="editMarksForm">
                    <input type="hidden" id="editMarksId">
                    
                    <div class="mb-3">
                        <label class="form-label-custom">Marks Obtained (0-100)</label>
                        <input type="number" class="form-control-custom w-100" id="editMarksInput" min="0" max="100" placeholder="Enter marks" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label-custom">Attendance Percentage (0-100)</label>
                        <input type="number" class="form-control-custom w-100" id="editAttendanceInput" min="0" max="100" placeholder="Enter attendance %" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem;">
                <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-primary-custom" onclick="updateMarks()">Update Marks</button>
            </div>
        </div>
    </div>
</div>

<style>
    .table-custom {
        width: 100%;
    }

    @media (max-width: 768px) {
        .table-custom {
            font-size: 0.85rem;
        }

        .table-custom th,
        .table-custom td {
            padding: 0.75rem !important;
        }

        .btn-edit,
        .btn-danger-custom {
            padding: 0.3rem 0.6rem !important;
            font-size: 0.7rem !important;
        }
    }
</style>

<script>
    let allMarks = [];
    let allStudents = [];
    let allSubjects = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadStudents();
        loadSubjects();
        loadMarks();
    });

    async function loadStudents() {
        try {
            const response = await fetch('/analytics/api/students/');
            allStudents = await response.json();
            
            // Populate student select dropdowns
            const studentSelect = document.getElementById('studentSelect');
            const studentFilter = document.getElementById('studentFilter');
            
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            studentFilter.innerHTML = '<option value="">All Students</option>';
            
            allStudents.forEach(student => {
                studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.roll_no})</option>`;
                studentFilter.innerHTML += `<option value="${student.id}">${student.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading students:', error);
        }
    }

    async function loadSubjects() {
        try {
            const response = await fetch('/analytics/api/subjects/');
            allSubjects = await response.json();
            
            // Populate subject select dropdowns
            const subjectSelect = document.getElementById('subjectSelect');
            const subjectFilter = document.getElementById('subjectFilter');
            
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';
            
            allSubjects.forEach(subject => {
                subjectSelect.innerHTML += `<option value="${subject.id}">${subject.subject_name}</option>`;
                subjectFilter.innerHTML += `<option value="${subject.id}">${subject.subject_name}</option>`;
            });
        } catch (error) {
            console.error('Error loading subjects:', error);
        }
    }

    async function loadMarks() {
        try {
            const response = await fetch('/analytics/api/marks/');
            allMarks = await response.json();
            
            // Apply filters
            let filtered = allMarks;
            const studentFilter = document.getElementById('studentFilter').value;
            const subjectFilter = document.getElementById('subjectFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            if (studentFilter) {
                filtered = filtered.filter(m => m.student_id === parseInt(studentFilter));
            }
            if (subjectFilter) {
                filtered = filtered.filter(m => m.subject_id === parseInt(subjectFilter));
            }
            if (searchInput) {
                filtered = filtered.filter(m => 
                    m.student_name.toLowerCase().includes(searchInput) ||
                    m.subject_name.toLowerCase().includes(searchInput)
                );
            }
            
            if (filtered.length === 0) {
                document.getElementById('marksContainer').style.display = 'block';
                document.getElementById('marksTable').style.display = 'none';
            } else {
                document.getElementById('marksContainer').style.display = 'none';
                document.getElementById('marksTable').style.display = 'table';
                
                const tbody = document.getElementById('marksTableBody');
                tbody.innerHTML = '';
                
                filtered.forEach((mark) => {
                    const grade = getGrade(mark.marks_obtained);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="color: var(--accent-blue); font-weight: 500;">${mark.student_name}</td>
                        <td>${mark.student_roll_no}</td>
                        <td><span class="badge-custom badge-blue">${mark.subject_name}</span></td>
                        <td style="font-weight: 600; color: var(--accent-green);">${mark.marks_obtained}/100</td>
                        <td>${mark.attendance_percentage}%</td>
                        <td><span class="badge-custom badge-blue">${grade}</span></td>
                        <td>
                            <button class="btn-edit btn-sm" onclick="openEditModal(${mark.id}, ${mark.marks_obtained}, ${mark.attendance_percentage})">✏️ Edit</button>
                            <button class="btn-danger-custom btn-sm" onclick="deleteMark(${mark.id})">❌ Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error loading marks:', error);
        }
    }

    function getGrade(marks) {
        if (marks >= 90) return 'A+';
        if (marks >= 80) return 'A';
        if (marks >= 70) return 'B';
        if (marks >= 60) return 'C';
        if (marks >= 50) return 'D';
        return 'F';
    }

    async function addMarks() {
        const studentId = document.getElementById('studentSelect').value;
        const subjectId = document.getElementById('subjectSelect').value;
        const marks = document.getElementById('marksInput').value;
        const attendance = document.getElementById('attendanceInput').value;

        if (!studentId || !subjectId || !marks || !attendance) {
            alert('Please fill all fields');
            return;
        }

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/analytics/api/marks/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    student_id: studentId,
                    subject_id: subjectId,
                    marks_obtained: marks,
                    attendance_percentage: attendance
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Marks added successfully!');
                document.getElementById('addMarksForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addMarksModal')).hide();
                loadMarks();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error adding marks:', error);
            alert('Error adding marks. Please try again.');
        }
    }

    function openEditModal(id, marks, attendance) {
        document.getElementById('editMarksId').value = id;
        document.getElementById('editMarksInput').value = marks;
        document.getElementById('editAttendanceInput').value = attendance;
        
        const modal = new bootstrap.Modal(document.getElementById('editMarksModal'));
        modal.show();
    }

    async function updateMarks() {
        const id = document.getElementById('editMarksId').value;
        const marks = document.getElementById('editMarksInput').value;
        const attendance = document.getElementById('editAttendanceInput').value;

        if (!marks || !attendance) {
            alert('Please fill all fields');
            return;
        }

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`/analytics/api/marks/${id}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    marks_obtained: marks,
                    attendance_percentage: attendance
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Marks updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editMarksModal')).hide();
                loadMarks();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error updating marks:', error);
            alert('Error updating marks. Please try again.');
        }
    }

    async function deleteMark(id) {
        if (!confirm('Are you sure you want to delete this mark?')) {
            return;
        }

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`/analytics/api/marks/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('Mark deleted successfully!');
                loadMarks();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error deleting mark:', error);
            alert('Error deleting mark. Please try again.');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}
