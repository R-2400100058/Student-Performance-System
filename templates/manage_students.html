{% extends 'base.html' %}

{% block title %}Manage Students - Student Performance Analysis System{% endblock %}

{% block content %}
<div class="container-fluid" style="background-color: var(--primary-bg); min-height: calc(100vh - 70px); padding: 2rem 0;">
    <div class="container-xxl">
        <!-- Page Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h2 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.5rem;">Manage Students</h2>
                <p style="color: var(--text-secondary); margin-bottom: 0;">Add, edit, and manage student records</p>
            </div>
            <button class="btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                ➕ Add Student
            </button>
        </div>

        <!-- Students Table -->
        <div class="card-custom">
            <div id="studentsContainer">
                <!-- Students will be loaded here -->
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    <h3>No students available</h3>
                    <p>Add a student to begin managing performance data</p>
                </div>
            </div>

            <!-- Students Table (shown when students exist) -->
            <table class="table-custom" style="display: none;" id="studentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Roll No</th>
                        <th>Department</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <!-- Students will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-custom">
        <div class="modal-content modal-custom">
            <div class="modal-header">
                <h5 class="modal-title">Add New Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="mb-3">
                        <label for="firstName" class="form-label-custom">Student Name</label>
                        <input type="text" class="form-control-custom w-100" id="firstName" placeholder="Enter student name" required>
                    </div>

                    <div class="mb-3">
                        <label for="rollNo" class="form-label-custom">Roll No</label>
                        <input type="text" class="form-control-custom w-100" id="rollNo" placeholder="e.g., STU001" required>
                    </div>

                    <div class="mb-3">
                        <label for="department" class="form-label-custom">Department</label>
                        <input type="text" class="form-control-custom w-100" id="department" placeholder="e.g., Science" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem;">
                <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-primary-custom" onclick="addStudent()">Save Student</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-custom">
        <div class="modal-content modal-custom">
            <div class="modal-header">
                <h5 class="modal-title">Edit Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <input type="hidden" id="editStudentId">
                    
                    <div class="mb-3">
                        <label for="editFirstName" class="form-label-custom">Student Name</label>
                        <input type="text" class="form-control-custom w-100" id="editFirstName" placeholder="Enter student name" required>
                    </div>

                    <div class="mb-3">
                        <label for="editRollNo" class="form-label-custom">Roll No</label>
                        <input type="text" class="form-control-custom w-100" id="editRollNo" placeholder="e.g., STU001" required>
                    </div>

                    <div class="mb-3">
                        <label for="editDepartment" class="form-label-custom">Department</label>
                        <input type="text" class="form-control-custom w-100" id="editDepartment" placeholder="e.g., Science" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1rem;">
                <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-primary-custom" onclick="updateStudent()">Update Student</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modal styling overrides */
    .modal-content {
        background-color: var(--secondary-bg) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 10px !important;
    }

    .modal-header {
        background-color: var(--tertiary-bg) !important;
        border-bottom: 1px solid var(--border-color) !important;
    }

    .modal-header .btn-close {
        filter: invert(1) brightness(0.8) !important;
    }

    .modal-title {
        color: var(--text-primary) !important;
    }

    select.form-control-custom {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.7rem center;
        padding-right: 2.5rem !important;
    }

    /* Table responsive */
    @media (max-width: 768px) {
        .table-custom {
            font-size: 0.85rem;
        }

        .table-custom th,
        .table-custom td {
            padding: 0.75rem !important;
        }

        .btn-edit,
        .btn-danger-custom {
            padding: 0.3rem 0.6rem !important;
            font-size: 0.75rem !important;
        }
    }
</style>

<script>
    let editingStudentId = null;

    // Load students on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStudents();
    });

    async function loadStudents() {
        try {
            const response = await fetch('/analytics/api/students/');
            const students = await response.json();
            
            if (students.length === 0) {
                document.getElementById('studentsContainer').style.display = 'block';
                document.getElementById('studentsTable').style.display = 'none';
            } else {
                document.getElementById('studentsContainer').style.display = 'none';
                document.getElementById('studentsTable').style.display = 'table';
                
                const tbody = document.getElementById('studentTableBody');
                tbody.innerHTML = '';
                
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${String(student.id).padStart(3, '0')}</td>
                        <td style="color: var(--accent-blue); font-weight: 500;">${student.name}</td>
                        <td>${student.roll_no}</td>
                        <td><span class="badge-custom badge-blue">${student.department}</span></td>
                        <td>
                            <button class="btn-edit btn-sm" onclick="openEditModal(${student.id}, '${student.name}', '${student.roll_no}', '${student.department}')">✏️ Edit</button>
                            <button class="btn-danger-custom btn-sm" onclick="deleteStudent(${student.id})">❌ Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error loading students:', error);
            alert('Error loading students. Please try again.');
        }
    }

    async function addStudent() {
        const name = document.getElementById('firstName').value.trim();
        const rollNo = document.getElementById('rollNo').value.trim();
        const department = document.getElementById('department').value.trim();

        if (!name || !rollNo || !department) {
            alert('Please fill all fields');
            return;
        }

        try {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
            const response = await fetch('/analytics/api/students/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    name: name,
                    roll_no: rollNo,
                    department: department
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Student added successfully!');
                document.getElementById('addStudentForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                loadStudents();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error adding student:', error);
            alert('Error adding student. Please try again.');
        }
    }

    function openEditModal(id, name, rollNo, department) {
        editingStudentId = id;
        document.getElementById('editStudentId').value = id;
        document.getElementById('editFirstName').value = name;
        document.getElementById('editRollNo').value = rollNo;
        document.getElementById('editDepartment').value = department;
        
        const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
        modal.show();
    }

    async function updateStudent() {
        const id = document.getElementById('editStudentId').value;
        const name = document.getElementById('editFirstName').value.trim();
        const rollNo = document.getElementById('editRollNo').value.trim();
        const department = document.getElementById('editDepartment').value.trim();

        if (!name || !rollNo || !department) {
            alert('Please fill all fields');
            return;
        }

        try {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
            const response = await fetch(`/analytics/api/students/${id}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    name: name,
                    roll_no: rollNo,
                    department: department
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Student updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error updating student:', error);
            alert('Error updating student. Please try again.');
        }
    }

    async function deleteStudent(id) {
        if (!confirm('Are you sure you want to delete this student?')) {
            return;
        }

        try {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
            const response = await fetch(`/analytics/api/students/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('Student deleted successfully!');
                loadStudents();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error deleting student:', error);
            alert('Error deleting student. Please try again.');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
