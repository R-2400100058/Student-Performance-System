{% extends 'base.html' %}

{% block title %}Dashboard - Student Performance Analysis System{% endblock %}

{% block content %}
<div class="container-fluid" style="background-color: var(--primary-bg); min-height: calc(100vh - 70px); padding: 2rem 0;">
    <div class="container-xxl">
        <!-- Page Header -->
        <div style="margin-bottom: 2rem;">
            <h2 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.5rem;">Dashboard</h2>
            <p style="color: var(--text-secondary); margin-bottom: 0;">Monitor and analyze student performance in real-time</p>
        </div>

        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" id="total-students">0</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">Active learners</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-label">Average Score</div>
                    <div class="stat-value" id="avg-score">0%</div>
                    <div style="color: var(--accent-green); font-size: 0.85rem;">Overall performance</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-label">Attendance Rate</div>
                    <div class="stat-value" id="attendance">0%</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">Average attendance</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-label">Pass Rate</div>
                    <div class="stat-value" id="pass-rate">0%</div>
                    <div style="color: var(--accent-green); font-size: 0.85rem;">Students passing all subjects</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <h3 style="margin-bottom: 1.5rem;">Performance Trend</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <h3 style="margin-bottom: 1.5rem;">Subject Comparison</h3>
                    <div class="chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card-custom">
            <h3 style="margin-bottom: 1.5rem;">Performance Summary</h3>
            <div class="row">
                <div class="col-md-6">
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-primary);">Excellent (80-100)</span>
                            <span style="color: var(--accent-blue);" id="excellent-percent">0%</span>
                        </div>
                        <div style="height: 8px; background-color: var(--tertiary-bg); border-radius: 4px; overflow: hidden;">
                            <div id="excellent-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-blue), #60a5fa); border-radius: 4px;"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-primary);">Good (60-79)</span>
                            <span style="color: var(--accent-green);" id="good-percent">0%</span>
                        </div>
                        <div style="height: 8px; background-color: var(--tertiary-bg); border-radius: 4px; overflow: hidden;">
                            <div id="good-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-green), #34d399); border-radius: 4px;"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-primary);">Average (40-59)</span>
                            <span style="color: var(--accent-orange);" id="average-percent">0%</span>
                        </div>
                        <div style="height: 8px; background-color: var(--tertiary-bg); border-radius: 4px; overflow: hidden;">
                            <div id="average-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-orange), #fbbf24); border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div style="background-color: var(--tertiary-bg); border-radius: 8px; padding: 1.5rem; text-align: center;">
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">CLASS AVERAGE</div>
                        <div style="color: var(--accent-blue); font-size: 2.5rem; font-weight: 700;" id="class-avg">0%</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">Based on <span id="total-marks-count">0</span> records</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let performanceChart = null;
    let subjectChart = null;

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // Load stats
            const statsResponse = await fetch('/analytics/api/dashboard-stats/');
            const stats = await statsResponse.json();
            
            document.getElementById('total-students').textContent = stats.total_students;
            document.getElementById('avg-score').textContent = stats.average_score + '%';
            document.getElementById('attendance').textContent = stats.attendance + '%';
            document.getElementById('pass-rate').textContent = stats.pass_rate + '%';
            document.getElementById('class-avg').textContent = stats.average_score + '%';
            document.getElementById('total-marks-count').textContent = stats.total_marks;

            // Calculate grade distribution
            calculateGradeDistribution(stats);

            // Load performance chart data
            const performanceResponse = await fetch('/analytics/api/performance-data/');
            const performanceData = await performanceResponse.json();
            loadPerformanceChart(performanceData);

            // Load subject chart data
            const subjectResponse = await fetch('/analytics/api/subject-data/');
            const subjectData = await subjectResponse.json();
            loadSubjectChart(subjectData);
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    function calculateGradeDistribution(stats) {
        // Calculate percentage of grades
        const totalMarks = stats.total_marks;
        
        // You can customize this based on your Mark data
        // For now, using average distribution
        const excellent = 24; // 24%
        const good = 48;      // 48%
        const average = 20;   // 20%
        const poor = 8;       // 8%

        document.getElementById('excellent-percent').textContent = excellent + '%';
        document.getElementById('excellent-bar').style.width = excellent + '%';
        
        document.getElementById('good-percent').textContent = good + '%';
        document.getElementById('good-bar').style.width = good + '%';
        
        document.getElementById('average-percent').textContent = average + '%';
        document.getElementById('average-bar').style.width = average + '%';
    }

    function loadPerformanceChart(data) {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        if (performanceChart) {
            performanceChart.destroy();
        }

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Average Score',
                    data: data.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#cbd5e1',
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(71, 85, 105, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#cbd5e1'
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#cbd5e1'
                        }
                    }
                }
            }
        });
    }

    function loadSubjectChart(data) {
        const ctx = document.getElementById('subjectChart').getContext('2d');
        
        if (subjectChart) {
            subjectChart.destroy();
        }

        subjectChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Average Score',
                    data: data.data,
                    backgroundColor: [
                        '#3b82f6',
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6'
                    ],
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: '#cbd5e1',
                            padding: 20
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(71, 85, 105, 0.3)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#cbd5e1'
                        }
                    },
                    y: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#cbd5e1'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
